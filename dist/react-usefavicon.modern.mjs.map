{"version":3,"file":"react-usefavicon.modern.mjs","sources":["../src/use-favicon.ts","../src/draw-functions.ts"],"sourcesContent":["import * as React from \"react\";\nimport { renderToStaticMarkup } from \"react-dom/server\";\n\nconst createCanvas = (faviconSize: number) => {\n  const canvas = document.createElement(\"canvas\");\n  canvas.width = faviconSize;\n  canvas.height = faviconSize;\n\n  return canvas;\n};\n\nexport type DrawCallback = (context: CanvasRenderingContext2D, faviconSize: number, options: Record<PropertyKey, unknown>) => void\n\nconst svgFaviconTemplate = (emoji: string) =>\n  `<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22>\n<text y=%22.9em%22 font-size=%2290%22>\n${emoji}\n</text>\n</svg>`.trim();\n\nfunction useFavicon() {\n  const [faviconHref, setFaviconHref] = React.useState<string>(null!);\n  const faviconTagRef = React.useRef<HTMLLinkElement>(null!);\n  const [originalHref, setOriginalHref] = React.useState<string>(null!);\n\n  // Grab initial favicon on mount\n  React.useEffect(() => {\n    // how do i know this is the right link element for sure though?\n    const linkEl: HTMLLinkElement =\n      document.querySelector(\"link[rel~='icon']\") ||\n      document.head.appendChild(document.createElement(\"link\"));\n\n    faviconTagRef.current = linkEl;\n\n    setFaviconHref(faviconTagRef.current.href);\n    setOriginalHref(faviconTagRef.current.href);\n  }, []);\n\n  React.useEffect(() => {\n      faviconTagRef.current.setAttribute(\"href\", faviconHref);\n  }, [faviconHref]);\n\n  const restoreFavicon = React.useCallback(() => {\n    setFaviconHref(originalHref);\n  }, [originalHref]);\n\n  const jsxToFavicon = React.useCallback((SvgEl: React.ReactSVGElement) => {\n    if (SvgEl.type !== \"svg\")\n      throw Error(\"React element for 'jsxToFavicon' must of type 'svg'\");\n\n    const renderedToString = renderToStaticMarkup(SvgEl);\n    const encoded = encodeURIComponent(renderedToString);\n    const replacedHashes = encoded.replace(/#/g, \"%23\");\n\n    setFaviconHref(`data:image/svg+xml,${replacedHashes}`);\n  }, []);\n\n  const setEmojiFavicon = React.useCallback((emoji: string) => {\n    setFaviconHref(`data:image/svg+xml,${svgFaviconTemplate(emoji)}`);\n  }, []);\n\n  const drawOnFavicon = React.useCallback(\n    (\n      drawCallback: DrawCallback,\n      { faviconSize = 256, clear = false, ...options } = {}\n    ) => {\n      const canvas = createCanvas(faviconSize);\n\n      const img = document.createElement(\"img\");\n      img.setAttribute(\"src\", faviconHref);\n\n      // The load event fires when a given resource has loaded, so when the <img> src attribute has changed\n      img.onload = () => {\n        const context = canvas.getContext(\"2d\");\n\n        if (!context) {\n          console.warn(\"Could not create drawing context for favicon\");\n          return;\n        }\n\n        if (!clear) context.drawImage(img, 0, 0, faviconSize, faviconSize); // Draw current favicon as background\n\n        drawCallback(context, faviconSize, options);\n\n        const pngURI = canvas.toDataURL(\"image/png\");\n        setFaviconHref(pngURI);\n      };\n    },\n    [faviconHref]\n  );\n\n  const handlers = React.useMemo(\n    () => ({\n      jsxToFavicon,\n      restoreFavicon,\n      drawOnFavicon,\n      setFaviconHref,\n      setEmojiFavicon,\n    }),\n    [\n      jsxToFavicon,\n      restoreFavicon,\n      drawOnFavicon,\n      setFaviconHref,\n      setEmojiFavicon,\n    ]\n  );\n\n  return [faviconHref, handlers] as const;\n}\n\nexport { useFavicon };\nexport default useFavicon;\n","interface DrawCircleOptions {\n  fillColor: string;\n  radius: number;\n  x: number;\n  y: number;\n}\n\nexport const drawCircle = (\n  context: CanvasRenderingContext2D,\n  faviconSize: number,\n  options: DrawCircleOptions\n) => {\n  const {\n    fillColor = \"red\",\n    radius = faviconSize / 5,\n    x = faviconSize - faviconSize / 5,\n    y = faviconSize - faviconSize / 5,\n    \n  } = options;\n\n  context.beginPath();\n  context.arc(\n    x,\n    y,\n    radius,\n    0, // startAngle\n    2 * Math.PI // endAngle\n  );\n  context.fillStyle = fillColor;\n  context.fill();\n};\n\ninterface DrawSquareOptions {\n  fillColor: string;\n  length: number;\n  x: number;\n  y: number;\n}\n\nexport const drawSquare = (\n  context: CanvasRenderingContext2D,\n  faviconSize: number,\n  options: DrawSquareOptions\n) => {\n  const {\n    fillColor = \"black\",\n    length = faviconSize / 5,\n    x = faviconSize - faviconSize / 5,\n    y = faviconSize - faviconSize / 5,\n  } = options;\n\n  context.beginPath();\n  context.fillStyle = fillColor;\n  context.fillRect(\n    x,\n    y,\n    length, \n    length \n  );\n  context.fill();\n};\n\ninterface DrawTextBubbleOptions {\n  label: string;\n  color: string;\n  fontSize: number;\n  font: string;\n}\n\n// adapted from https://github.com/tommoor/tinycon/blob/master/tinycon.js#L167\nexport const drawTextBubble = (\n  context: CanvasRenderingContext2D,\n  faviconSize: number,\n  options: Partial<DrawTextBubbleOptions>\n) => {\n  const {\n    label = \"\",\n    color = \"orangered\",\n    fontSize = faviconSize / 2,\n    font = \"sans-serif\",\n  } = options;\n\n  // these numbers are pure trial and error I should have thought about them more it works ok though\n  // bubble needs to be wider for double digits, 4 digits max now\n  const extraWidth = (label.length * faviconSize) / 5;\n\n  const bubbleWidth = faviconSize / 3 + extraWidth;\n  const bubbleHeight = faviconSize / 1.5; // 2/3\n\n  const top = faviconSize - bubbleHeight,\n    left = faviconSize - bubbleWidth,\n    bottom = faviconSize,\n    right = faviconSize,\n    radius = faviconSize / 8,\n    textX =\n      label.length > 1\n        ? faviconSize - bubbleWidth / 4.75 + extraWidth / 4\n        : faviconSize - bubbleWidth / 4.75,\n    textY = faviconSize - bubbleHeight / 8;\n\n  context.fillStyle = color;\n  context.lineWidth = 12;\n\n  // bubble\n  context.beginPath();\n  context.moveTo(left + radius, top); //start\n  context.quadraticCurveTo(left, top, left, top + radius);\n  context.lineTo(left, bottom - radius);\n  context.quadraticCurveTo(left, bottom, left + radius, bottom);\n  context.lineTo(right - radius, bottom);\n  context.quadraticCurveTo(right, bottom, right, bottom - radius);\n  context.lineTo(right, top + radius);\n  context.quadraticCurveTo(right, top, right - radius, top);\n  context.closePath();\n  context.fill();\n\n  // bottom shadow\n  context.beginPath();\n  context.strokeStyle = \"rgba(0,0,0,0.3)\";\n  context.moveTo(left + radius / 2.0, bottom);\n  context.lineTo(right - radius / 2.0, bottom);\n  context.stroke();\n\n  // label\n  context.fillStyle = \"white\";\n  context.textAlign = \"right\";\n  context.textBaseline = \"bottom\";\n  context.lineWidth = faviconSize / 16;\n\n  context.fillStyle = \"white\";\n  context.font = `${fontSize}px ${font}`;\n\n  context.fillText(label, textX, textY);\n};\n\n"],"names":["createCanvas","faviconSize","canvas","document","createElement","width","height","svgFaviconTemplate","emoji","trim","useFavicon","faviconHref","setFaviconHref","React","useState","faviconTagRef","useRef","originalHref","setOriginalHref","useEffect","linkEl","querySelector","head","appendChild","current","href","setAttribute","restoreFavicon","useCallback","jsxToFavicon","SvgEl","type","Error","renderedToString","renderToStaticMarkup","encoded","encodeURIComponent","replacedHashes","replace","setEmojiFavicon","drawOnFavicon","drawCallback","_ref","clear","options","_objectWithoutPropertiesLoose","_excluded","img","onload","context","getContext","console","warn","drawImage","pngURI","toDataURL","handlers","useMemo","drawCircle","fillColor","radius","x","y","beginPath","arc","Math","PI","fillStyle","fill","drawSquare","length","fillRect","drawTextBubble","label","color","fontSize","font","extraWidth","bubbleWidth","bubbleHeight","top","left","bottom","right","textX","textY","lineWidth","moveTo","quadraticCurveTo","lineTo","closePath","strokeStyle","stroke","textAlign","textBaseline","fillText"],"mappings":"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"}